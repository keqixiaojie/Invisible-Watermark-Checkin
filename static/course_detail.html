<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯¾ç¨‹è¯¦æƒ…</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        .card { border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-action { width: 100%; margin-bottom: 5px; }
        /* çŠ¶æ€å¾½ç« å¾®è°ƒ */
        .badge-running { background-color: #e7f1ff; color: #0d6efd; border: 1px solid #0d6efd; }
        .badge-finished { background-color: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6; }
    </style>
</head>
<body class="bg-light p-4">

    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="liveToast" class="toast align-items-center text-white bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="toast-msg">
                    æ“ä½œæˆåŠŸ
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>
    <div class="modal fade" id="startSessionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">ğŸš€ å¼€å¯æ–°ç­¾åˆ°</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-3" style="font-size: 3rem;">ğŸ“º</div>
                    <p class="mb-1 fs-5">ç¡®å®šè¦ç«‹å³å¼€å§‹ç­¾åˆ°å—ï¼Ÿ</p>
                    <p class="text-muted small">å¦‚æœ‰æ­£åœ¨è¿›è¡Œçš„ç­¾åˆ°å°†è‡ªåŠ¨ç»“æŸã€‚</p>
                </div>
                <div class="modal-footer justify-content-center border-0 pb-4">
                    <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary px-4" onclick="confirmStartSession()">ç¡®å®šå¼€å¯</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container" style="max-width: 900px;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <button onclick="location.href='teacher_dashboard.html'" class="btn btn-outline-secondary">â† è¿”å›è¯¾ç¨‹åˆ—è¡¨</button>
            <h4 class="mb-0 fw-bold" id="course-title">åŠ è½½ä¸­...</h4>
            <div style="width: 100px;"></div> </div>

        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card h-100 bg-white border-primary border-2">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h5 class="card-title text-primary fw-bold">ğŸš€ å‘èµ·æ–°ç­¾åˆ°</h5>
                            <p class="card-text text-muted small mb-0">ç³»ç»Ÿå°†è‡ªåŠ¨åˆ›å»ºå¹¶æ¿€æ´»æ–°çš„ç­¾åˆ°ä¼šè¯ï¼Œç›´æ¥è¿›å…¥å¤§å±æ¨¡å¼ã€‚</p>
                        </div>
                        <button onclick="startNewSession()" class="btn btn-primary btn-lg px-4 shadow-sm">ç«‹å³å¼€å§‹</button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <input type="file" id="file-input" accept=".xlsx, .xls" style="display: none;" onchange="uploadRoster()">
                        <button onclick="document.getElementById('file-input').click()" class="btn btn-outline-success w-100 mb-2">
                            ğŸ“¥ å¯¼å…¥åå• (Excel)
                        </button>
                        <div class="text-center text-muted small">
                            å½“å‰äººæ•°: <span id="student-count" class="fw-bold text-dark">0</span> äºº
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <h6 class="card-title text-muted mb-3">ğŸ“Š å†å²å‡ºå‹¤ç‡è¶‹åŠ¿</h6>
                <div id="chart-main" style="width: 100%; height: 250px;"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-bold">ğŸ“… ç­¾åˆ°è®°å½•</h5>
            </div>
            <div class="card-body p-0">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">æ—¥æœŸ/æ—¶é—´</th>
                            <th>çŠ¶æ€</th>
                            <th class="text-center">å‡ºå‹¤æƒ…å†µ</th>
                            <th class="text-end pe-4">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="session-list">
                        <tr><td colspan="4" class="text-center text-muted py-4">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="mt-4 text-center">
            <button class="btn btn-link text-muted text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#rosterCollapse">
                æŸ¥çœ‹è¯¦ç»†å­¦ç”Ÿåå• â–¼
            </button>
        </div>
        <div class="collapse mt-2" id="rosterCollapse">
            <div class="card card-body">
                <table class="table table-sm table-striped">
                    <thead><tr><th>å­¦å·</th><th>å§“å</th><th>ç­çº§</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="roster-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        const token = localStorage.getItem("token");
        const toastEl = document.getElementById('liveToast');
        const toast = new bootstrap.Toast(toastEl, { delay: 3000 });

        // URL å‚æ•°å¤„ç†
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('id');
        const courseName = decodeURIComponent(urlParams.get('name') || "è¯¾ç¨‹è¯¦æƒ…");

        // åˆå§‹åŒ–
        if(!token) location.href = "teacher_dashboard.html";
        document.getElementById('course-title').innerText = courseName;

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            loadStudents();
            loadHistorySessions();
            loadChart();
        });

        // --- æ ¸å¿ƒåŠŸèƒ½ 1: ç«‹å³å¼€å§‹æ–°ç­¾åˆ° (æ›¿ä»£é¢„çº¦) ---
        // 1. ç‚¹å‡»æŒ‰é’® -> å¼¹çª—
        function startNewSession() {
            const modalEl = document.getElementById('startSessionModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }

        // 2. ç‚¹å‡»ç¡®è®¤ -> è°ƒæ¥å£
        async function confirmStartSession() {
            // å…ˆå…³é—­å¼¹çª—
            const modalEl = document.getElementById('startSessionModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            try {
                const res = await fetch(`${API_URL}/courses/${courseId}/sessions/start`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (res.ok) {
                    showToast("âœ… ç­¾åˆ°å·²å¼€å¯ï¼Œæ­£åœ¨è·³è½¬...");
                    setTimeout(() => openBigScreen(data.session_id), 500);
                } else {
                    alert("å¼€å¯å¤±è´¥: " + data.detail);
                }
            } catch (e) {
                alert("ç½‘ç»œé”™è¯¯");
            }
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ 2: åŠ è½½å†å²è®°å½• (é€»è¾‘é‡æ„) ---
        async function loadHistorySessions() {
            try {
                const res = await fetch(`${API_URL}/courses/${courseId}/sessions`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const sessions = await res.json();
                
                const tbody = document.getElementById('session-list');
                
                if (sessions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">æš‚æ— ç­¾åˆ°è®°å½•</td></tr>';
                    return;
                }

                tbody.innerHTML = ""; 

                sessions.forEach(s => {
                    let statusBadge = '';
                    let actionBtns = '';
                    let timeDisplay = s.display_time;

                    // æ ¹æ® is_active å’Œ start_time åˆ¤æ–­çŠ¶æ€
                    // æ³¨æ„ï¼šå› ä¸ºå»æ‰äº†é¢„çº¦ï¼Œstart_time åº”è¯¥æ€»æ˜¯æœ‰å€¼çš„
                    if (s.status === 'running') {
                        // ğŸŸ¢ è¿›è¡Œä¸­
                        statusBadge = '<span class="badge badge-running">ğŸ”¥ è¿›è¡Œä¸­</span>';
                        actionBtns = `
                            <button onclick="openBigScreen(${s.id})" class="btn btn-sm btn-success me-1">ğŸ“º è¿›å…¥å¤§å±</button>
                            <button onclick="stopSession(${s.id})" class="btn btn-sm btn-outline-danger">â¹ï¸ ç»“æŸ</button>
                        `;
                    } else {
                        // âšª å·²ç»“æŸ (Finished)
                        statusBadge = '<span class="badge badge-finished">ğŸ å·²ç»“æŸ</span>';
                        // æ—¢ç„¶ç»“æŸäº†ï¼Œå°±ä¸èƒ½å†è¿›å¤§å±äº†ï¼Œé˜²æ­¢é€»è¾‘æ··ä¹±
                        actionBtns = `
                            <a href="session_report.html?sid=${s.id}" class="btn btn-sm btn-outline-secondary">ğŸ“Š æŸ¥çœ‹æŠ¥è¡¨</a>
                        `;
                    }

                    tbody.innerHTML += `
                        <tr class="align-middle">
                            <td class="ps-4 fw-bold text-dark">${timeDisplay}</td>
                            <td>${statusBadge}</td>
                            <td class="text-center fs-5 text-primary">${s.present_count}</td>
                            <td class="text-end pe-4">${actionBtns}</td>
                        </tr>
                    `;
                });
            } catch (err) {
                console.error(err);
            }
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ 3: ç»“æŸç­¾åˆ° ---
        async function stopSession(sid) {
            if(!confirm("ç¡®å®šè¦ç»“æŸè¿™æ¬¡ç­¾åˆ°å—ï¼Ÿç»“æŸç”Ÿå°†æ— æ³•ç»§ç»­æ‰«ç ã€‚")) return;
            
            try {
                const res = await fetch(`${API_URL}/courses/sessions/${sid}/stop`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    showToast("â¹ï¸ ç­¾åˆ°å·²ç»“æŸ");
                    loadHistorySessions(); // åˆ·æ–°åˆ—è¡¨ï¼ŒçŠ¶æ€å˜æ›´ä¸ºâ€œå·²ç»“æŸâ€
                } else {
                    alert("æ“ä½œå¤±è´¥");
                }
            } catch(e) { alert("ç½‘ç»œé”™è¯¯"); }
        }

        // --- è¾…åŠ©ï¼šè·³è½¬å¤§å± ---
        function openBigScreen(sid) {
            const safeName = encodeURIComponent(courseName);
            // æ˜ç¡®ä¼ é€’ sidï¼Œç¡®ä¿å¤§å±åŠ è½½çš„æ˜¯æŒ‡å®šçš„ä¼šè¯
            location.href = `teacher_screen.html?cid=${courseId}&name=${safeName}&sid=${sid}`;
        }

        // --- è¾…åŠ©ï¼šToast æç¤º ---
        function showToast(msg) {
            document.getElementById('toast-msg').innerText = msg;
            toast.show();
        }

        // --- å…¶ä»–åŸæœ‰åŠŸèƒ½ (å¯¼å…¥ã€åŠ è½½å­¦ç”Ÿã€å›¾è¡¨) ---
        async function loadStudents() {
            const res = await fetch(`${API_URL}/courses/${courseId}/students`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const students = await res.json();
            document.getElementById('student-count').innerText = students.length;
            
            const tbody = document.getElementById('roster-list');
            tbody.innerHTML = "";
            students.forEach(s => {
                tbody.innerHTML += `
                    <tr><td>${s.student_number}</td><td>${s.name}</td><td>${s.class_name}</td>
                    <td><button class="btn btn-sm btn-link text-danger text-decoration-none p-0" onclick="removeStudent('${s.student_number}')">ç§»é™¤</button></td></tr>
                `;
            });
        }

        async function uploadRoster() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append("file", file);

            try {
                showToast("â³ æ­£åœ¨ä¸Šä¼ ...");
                const res = await fetch(`${API_URL}/courses/${courseId}/import`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                const data = await res.json();
                if (res.ok) {
                    showToast("âœ… " + data.msg);
                    loadStudents();
                } else {
                    alert("å¯¼å…¥å¤±è´¥: " + data.detail);
                }
            } catch (err) { alert("ç½‘ç»œé”™è¯¯"); } finally { fileInput.value = ''; }
        }

        // ç®€å•çš„å›¾è¡¨åŠ è½½ (ä¿æŒåŸæœ‰é€»è¾‘)
        async function loadChart() {
            const chartDom = document.getElementById('chart-main');
            if(!chartDom) return;
            const myChart = echarts.init(chartDom);
            const res = await fetch(`${API_URL}/courses/${courseId}/stats_history`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            const option = {
                grid: { top: 30, bottom: 20, left: 40, right: 20 },
                tooltip: { trigger: 'axis' },
                xAxis: { type: 'category', data: data.dates },
                yAxis: { type: 'value', max: 100 },
                series: [{
                    data: data.rates, type: 'line', smooth: true,
                    itemStyle: { color: '#0d6efd' },
                    areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: 'rgba(13, 110, 253, 0.5)' }, { offset: 1, color: 'rgba(13, 110, 253, 0.0)' }]) }
                }]
            };
            myChart.setOption(option);
            window.onresize = function() { myChart.resize(); };
        }
    </script>
</body>
</html>