<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ç­¾åˆ°æŠ¥è¡¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-select { 
            border: 1px solid transparent; 
            background: transparent; 
            cursor: pointer; 
            font-weight: bold; 
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .status-select:hover { border-color: #ccc; background-color: #f8f9fa; }
        
        /* çŠ¶æ€é¢œè‰²å®šä¹‰ */
        .st-present { color: #198754; } /* Green */
        .st-absent { color: #dc3545; }  /* Red */
        .st-late { color: #ffc107; }    /* Yellow */
        .st-leave { color: #6c757d; }   /* Gray */
        
        .summary-card { border: none; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="bg-light p-4">

    <div class="container" style="max-width: 900px;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <a id="back-btn" href="#" class="btn btn-outline-secondary">â† è¿”å›è¯¾ç¨‹è¯¦æƒ…</a>
            <h4 class="mb-0">ğŸ“‘ ç­¾åˆ°ç»“æœæŠ¥è¡¨</h4>
            <div style="width: 100px;"></div> </div>

        <div class="row mb-4 text-center">
            <div class="col-md-4">
                <div class="card summary-card bg-white p-3">
                    <h3 class="text-success fw-bold" id="present-count">-</h3>
                    <div class="text-muted">å®åˆ°äººæ•°</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card summary-card bg-white p-3">
                    <h3 class="text-danger fw-bold" id="absent-count">-</h3>
                    <div class="text-muted">ç¼ºå‹¤äººæ•°</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card summary-card bg-white p-3">
                    <h3 class="text-primary fw-bold" id="rate">-</h3>
                    <div class="text-muted">å‡ºå‹¤ç‡</div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end mb-3">
            <button onclick="exportExcel()" class="btn btn-success">
                ğŸ“¥ å¯¼å‡ºæœ¬æ¬¡è€ƒå‹¤ Excel
            </button>
        </div>

        <div class="card shadow-sm">
            <div class="card-body p-0">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">å­¦å·</th>
                            <th>å§“å</th>
                            <th>ç­çº§</th>
                            <th>çŠ¶æ€ (ç‚¹å‡»ä¿®æ”¹)</th>
                        </tr>
                    </thead>
                    <tbody id="record-list">
                        <tr><td colspan="4" class="text-center py-4 text-muted">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_URL = window.location.origin;
        const token = localStorage.getItem("token");
        
        // URL å‚æ•°è§£æ
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('sid');
        const courseId = urlParams.get('cid');
        const courseName = urlParams.get('name');

        // åˆå§‹åŒ–è¿”å›æŒ‰é’®
        const backBtn = document.getElementById('back-btn');
        if (courseId) {
            const safeName = encodeURIComponent(courseName || 'è¯¾ç¨‹è¯¦æƒ…');
            backBtn.href = `course_detail.html?id=${courseId}&name=${safeName}`;
        } else {
            backBtn.href = "teacher_dashboard.html";
        }

        // é¡µé¢åŠ è½½
        window.onload = async () => {
            if(!token) location.href = "teacher_dashboard.html";
            if(!sessionId) { alert("ç¼ºå°‘å‚æ•°"); return; }
            await loadData();
        };

        // --- åŠ è½½æ•°æ® ---
        async function loadData() {
            try {
                // è°ƒç”¨ detail æ¥å£ (éœ€è¦åç«¯é…åˆå®ç°)
                const res = await fetch(`${API_URL}/courses/sessions/${sessionId}/detail`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (res.status === 401) { alert("ç™»å½•å·²è¿‡æœŸ"); location.href="teacher_dashboard.html"; return; }
                const list = await res.json();
                
                const tbody = document.getElementById('record-list');
                tbody.innerHTML = "";

                let present = 0, absent = 0;

                list.forEach(item => {
                    // ç»Ÿè®¡
                    if (['present', 'late'].includes(item.status)) present++;
                    else absent++;

                    // æ¸²æŸ“è¡Œ
                    // å¦‚æœ status æ˜¯ normal (æ—§æ•°æ®å…¼å®¹)ï¼Œè§†ä¸º present
                    let status = item.status === 'normal' ? 'present' : item.status;
                    let colorClass = `st-${status}`;

                    tbody.innerHTML += `
                        <tr>
                            <td class="ps-4">${item.student_number}</td>
                            <td>${item.name}</td>
                            <td>${item.class_name}</td>
                            <td>
                                <select class="status-select ${colorClass}" onchange="updateStatus('${item.student_number}', this)">
                                    <option value="present" ${status==='present'?'selected':''}>âœ… å·²åˆ°</option>
                                    <option value="absent" ${status==='absent'?'selected':''}>âŒ ç¼ºå‹¤</option>
                                    <option value="late" ${status==='late'?'selected':''}>âš ï¸ è¿Ÿåˆ°</option>
                                    <option value="leave" ${status==='leave'?'selected':''}>ğŸ¤’ è¯·å‡</option>
                                </select>
                            </td>
                        </tr>
                    `;
                });

                // æ›´æ–°é¡¶éƒ¨ç»Ÿè®¡
                const total = list.length;
                document.getElementById('present-count').innerText = present;
                document.getElementById('absent-count').innerText = total - present;
                const rate = total > 0 ? Math.round((present / total) * 100) : 0;
                document.getElementById('rate').innerText = rate + "%";

            } catch (e) {
                console.error(e);
                document.getElementById('record-list').innerHTML = `<tr><td colspan="4" class="text-center text-danger">åŠ è½½å¤±è´¥</td></tr>`;
            }
        }

        // --- ä¿®æ”¹çŠ¶æ€ ---
        async function updateStatus(studentNumber, selectEl) {
            const newStatus = selectEl.value;
            // ç«‹å³æ”¹å˜é¢œè‰²
            selectEl.className = `status-select st-${newStatus}`;

            try {
                const res = await fetch(`${API_URL}/courses/sessions/${sessionId}/records`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        student_number: studentNumber,
                        status: newStatus
                    })
                });
                if(res.ok) {
                    // ä¿®æ”¹æˆåŠŸï¼Œåˆ·æ–°ä¸€ä¸‹ç»Ÿè®¡æ•°æ® (é™é»˜åˆ·æ–°ï¼Œä¸é—ªå±)
                    loadData(); 
                } else {
                    alert("ä¿®æ”¹å¤±è´¥");
                    loadData(); // å¤±è´¥è¿˜åŸ
                }
            } catch(e) {
                alert("ç½‘ç»œé”™è¯¯");
            }
        }

        // --- å¯¼å‡º Excel ---
        async function exportExcel() {
            try {
                // ä½¿ç”¨ fetch ä¸‹è½½ï¼Œå¯ä»¥å¸¦ Header
                const res = await fetch(`${API_URL}/courses/sessions/${sessionId}/export`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (res.status !== 200) {
                    alert("å¯¼å‡ºå¤±è´¥"); return;
                }

                // å¤„ç†äºŒè¿›åˆ¶æµ
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `attendance_report_${sessionId}.xlsx`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url); // é‡Šæ”¾å†…å­˜
            } catch (e) {
                console.error(e);
                alert("å¯¼å‡ºå‡ºé”™");
            }
        }
    </script>
</body>
</html>