<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å¸ˆè¯¾ç¨‹æ§åˆ¶å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .page { display: none; }
        .active { display: block; }
        .progress-micro { height: 15px; font-size: 0.7rem; border-radius: 10px; }
        .course-card { transition: transform 0.2s; border: none; }
        .course-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important; }
        
        /* éª¨æ¶å±åŠ¨ç”» */
        .skeleton {
            background: #e0e0e0;
            background: linear-gradient(90deg, #eff1f3 25%, #e2e2e2 50%, #eff1f3 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 4px;
            color: transparent !important;
        }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        .empty-icon { font-size: 4rem; opacity: 0.5; margin-bottom: 15px; }
    </style>
</head>
<body class="bg-light p-4">

    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
        <div id="liveToast" class="toast align-items-center text-white bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="toast-msg">ç³»ç»Ÿé€šçŸ¥</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <div id="login-page" class="page active container" style="max-width: 400px; margin-top: 100px;">
        <div class="card p-4 shadow-lg border-0">
            <h3 class="text-center mb-4 text-primary fw-bold">ç­¾åˆ°ç³»ç»Ÿ Â· æ•™å¸ˆç«¯</h3>
            <input type="text" id="username" class="form-control mb-3" placeholder="ç”¨æˆ·å" value="teacher_wang">
            <input type="password" id="password" class="form-control mb-3" placeholder="å¯†ç " value="123">
            <button onclick="login()" class="btn btn-primary w-100 btn-lg">ç™»å½• / æ³¨å†Œ</button>
            <p id="login-msg" class="text-danger mt-2 text-center"></p>
        </div>
    </div>

    <div id="course-page" class="page container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold">æˆ‘çš„è¯¾ç¨‹</h2>
            <div class="d-flex align-items-center gap-3">
                <span class="text-muted small" id="user-display">æ¬¢è¿å›æ¥</span>
                <button onclick="logout()" class="btn btn-outline-danger btn-sm">é€€å‡º</button>
            </div>
        </div>

        <div class="card p-4 mb-5 border-0 shadow-sm">
            <h5 class="mb-3">â• åˆ›å»ºæ–°è¯¾ç¨‹</h5>
            <div class="row g-2">
                <div class="col-md-4"><input type="text" id="c-name" class="form-control" placeholder="è¯¾ç¨‹å"></div>
                <div class="col-md-3"><input type="text" id="c-sem" class="form-control" placeholder="å­¦æœŸ (å¦‚: 2023ç§‹)"></div>
                <div class="col-md-3"><input type="text" id="c-loc" class="form-control" placeholder="åœ°ç‚¹"></div>
                <div class="col-md-2"><button onclick="createCourse()" class="btn btn-success w-100">ç«‹å³åˆ›å»º</button></div>
            </div>
        </div>

        <div id="course-list" class="row"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_URL = window.location.origin;
        let token = localStorage.getItem("token");
        let toastInstance = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            const toastEl = document.getElementById('liveToast');
            toastInstance = new bootstrap.Toast(toastEl, { delay: 3000 });

            if (token) {
                switchPage('course-page');
                loadCourses();

                // ã€æ–°å¢ã€‘æ˜¾ç¤ºç”¨æˆ·å
                displayUsername();
            }
        });

        // ==========================================
        // ã€æ–°å¢ã€‘è§£æ Token è·å–ç”¨æˆ·åå¹¶æ˜¾ç¤º
        // ==========================================
        function displayUsername() {
            try {
                if (!token) return;
                
                // 1. JWT çš„ç¬¬äºŒéƒ¨åˆ†æ˜¯ Payload (Base64ç¼–ç )
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                
                // 2. è§£ç  Base64 (å¤„ç†ä¸­æ–‡ä¹±ç )
                const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                // 3. è§£æ JSON
                const payload = JSON.parse(jsonPayload);
                
                // 4. è·å– sub å­—æ®µ (é€šå¸¸å­˜æ”¾ç”¨æˆ·å)
                const username = payload.sub || "è€å¸ˆ";
                
                // 5. æ›´æ–° UI
                document.getElementById('user-display').innerHTML = `ğŸ‘‹ æ¬¢è¿å›æ¥ï¼Œ<b>${username}</b>`;
                
            } catch (e) {
                console.error("è§£æTokenå¤±è´¥", e);
                document.getElementById('user-display').innerText = "æ¬¢è¿å›æ¥";
            }
        }

        // ==========================================
        // ã€æ ¸å¿ƒä¼˜åŒ–ã€‘ç»Ÿä¸€è¯·æ±‚å°è£… (è‡ªåŠ¨åŠ Token + è‡ªåŠ¨ç™»å‡º)
        // ==========================================
        async function authFetch(endpoint, options = {}) {
            // 1. è‡ªåŠ¨åˆå¹¶ Header (å¸¦ä¸Š Token)
            const headers = {
                'Authorization': `Bearer ${token}`,
                ...(options.headers || {}) // åˆå¹¶ç”¨æˆ·ä¼ å…¥çš„ header
            };

            // 2. å‘èµ·è¯·æ±‚
            const res = await fetch(`${API_URL}${endpoint}`, {
                ...options,
                headers: headers
            });

            // 3. ã€è‡ªåŠ¨ç™»å‡ºã€‘å¦‚æœé‡åˆ° 401 Unauthorized
            if (res.status === 401) {
                console.warn("Tokenå·²è¿‡æœŸï¼Œè‡ªåŠ¨ç™»å‡º");
                alert("ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
                logout(); // è¸¢å›ç™»å½•é¡µ
                return null; // ä¸­æ–­åç»­é€»è¾‘
            }

            return res;
        }

        // --- è¾…åŠ©å‡½æ•° ---
        function showToast(msg) {
            document.getElementById('toast-msg').innerText = msg;
            toastInstance.show();
        }

        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        function logout() {
            localStorage.removeItem("token");
            location.reload(); // åˆ·æ–°é¡µé¢å›åˆ°åˆå§‹çŠ¶æ€
        }

        // --- 1. ç™»å½• (ç™»å½•ä¸éœ€è¦ç”¨ authFetchï¼Œå› ä¸ºè¿˜æ²¡æœ‰ Token) ---
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const formData = new URLSearchParams();
            formData.append('username', username);
            formData.append('password', password);

            try {
                let res = await fetch(`${API_URL}/auth/login`, { method: 'POST', body: formData });
                
                // ç™»å½•æ¥å£çš„ 401 æ˜¯å¯†ç é”™è¯¯ï¼Œä¸åº”è¯¥è§¦å‘è‡ªåŠ¨ç™»å‡ºé€»è¾‘
                if (res.status === 401) {
                    if(confirm("è´¦å·æˆ–å¯†ç é”™è¯¯ã€‚æ˜¯å¦æ³¨å†Œæ–°è´¦å·ï¼Ÿ")) {
                        res = await fetch(`${API_URL}/auth/register`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({username, password, role: 'teacher'})
                        });
                    } else return;
                }
                
                if (!res.ok) throw new Error("ç™»å½•å¤±è´¥");

                const data = await res.json();
                token = data.access_token;
                localStorage.setItem("token", token);
                switchPage('course-page');
                loadCourses();
            } catch (err) {
                document.getElementById('login-msg').innerText = err.message;
            }
        }

        // --- 2. è¯¾ç¨‹åˆ—è¡¨ ---
        let pollInterval = null;

        async function loadCourses() {
            const listDiv = document.getElementById('course-list');
            
            if (!pollInterval && listDiv.innerHTML.trim() === "") {
                listDiv.innerHTML = generateSkeleton(3);
            }

            try {
                // ä½¿ç”¨ authFetchï¼Œè·¯å¾„åªéœ€è¦å†™ /courses/
                const res = await authFetch('/courses/');
                if (!res) return; // å¦‚æœæ˜¯ 401ï¼ŒauthFetch å·²ç»å¤„ç†äº†è·³è½¬ï¼Œè¿™é‡Œç›´æ¥è¿”å›

                const courses = await res.json();
                
                if (courses.length === 0) {
                    listDiv.innerHTML = `
                        <div class="col-12 empty-state">
                            <div class="empty-icon">ğŸ“­</div>
                            <h4>æš‚æ— è¯¾ç¨‹</h4>
                            <p>è¿˜æ²¡æœ‰è¯¾ç¨‹å“¦ï¼Œå¿«ç‚¹å‡»ä¸Šæ–¹åˆ›å»ºç¬¬ä¸€é—¨è¯¾ç¨‹å§ï¼</p>
                        </div>`;
                    return;
                }

                listDiv.innerHTML = ""; 
                let hasProcessingTask = false;

                courses.forEach(c => {
                    let footerHtml = '';
                    let cardClass = 'shadow-sm'; 

                    if (c.status === 'completed') {
                        footerHtml = `
                            <div class="d-flex gap-2">
                                <button onclick="location.href='course_detail.html?id=${c.id}&name=${encodeURIComponent(c.course_name)}'" class="btn btn-primary flex-grow-1">è¿›å…¥ç®¡ç†</button>
                                <button onclick="deleteCourse(${c.id})" class="btn btn-outline-danger">åˆ é™¤</button>
                            </div>`;
                    } else if (c.status === 'processing') {
                        hasProcessingTask = true;
                        cardClass = 'border-primary border-2';
                        footerHtml = `
                            <div class="d-flex align-items-center justify-content-between mb-1">
                                <small class="text-primary fw-bold">ğŸš€ æ­£åœ¨ç”Ÿæˆ...</small>
                                <small class="text-muted">${c.progress}%</small>
                            </div>
                            <div class="progress progress-micro">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                     style="width: ${c.progress}%"></div>
                            </div>`;
                    } else if (c.status === 'pending') {
                        cardClass = 'border-warning border-2';
                        footerHtml = `
                            <div class="text-center text-warning mb-2"><small>âš ï¸ ä»»åŠ¡å·²ä¸­æ–­</small></div>
                            <div class="d-flex gap-2">
                                <button onclick="regenerate(${c.id})" class="btn btn-warning text-white flex-grow-1 btn-sm">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
                                <button onclick="deleteCourse(${c.id})" class="btn btn-outline-secondary btn-sm">åˆ é™¤</button>
                            </div>`;
                    } else {
                        // çŠ¶æ€ï¼šå‡ºé”™
                        // æ”¹ä¸ºï¼šæ˜¾ç¤ºå…·ä½“é”™è¯¯åŸå› ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œå¹¶æä¾›â€œé‡è¯•â€å’Œâ€œåˆ é™¤â€ä¸¤ä¸ªé€‰æ‹©
                        cardClass = 'border-danger border-2'; // çº¢æ¡†è­¦ç¤º
                        footerHtml = `
                            <div class="text-center text-danger mb-2">
                                <small>âŒ ç”Ÿæˆå¤±è´¥</small>
                            </div>
                            <div class="d-flex gap-2">
                                <button onclick="regenerate(${c.id})" class="btn btn-danger text-white flex-grow-1 btn-sm">ğŸ”„ é‡è¯•</button>
                                
                                <button onclick="deleteCourse(${c.id})" class="btn btn-outline-secondary btn-sm">åˆ é™¤</button>
                            </div>
                        `;
                    }

                    listDiv.innerHTML += `
                        <div class="col-md-4 mb-4">
                            <div class="card h-100 course-card ${cardClass}">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title fw-bold mb-1">${c.course_name}</h5>
                                    <p class="card-text text-muted small mb-4">ğŸ“… ${c.semester} &nbsp;|&nbsp; ğŸ“ ${c.location}</p>
                                    <div class="mt-auto">${footerHtml}</div>
                                </div>
                            </div>
                        </div>`;
                });

                if (hasProcessingTask) {
                    if (!pollInterval) {
                        console.log("å¯åŠ¨è½®è¯¢...");
                        pollInterval = setInterval(loadCourses, 2000);
                    }
                } else {
                    if (pollInterval) {
                        console.log("åœæ­¢è½®è¯¢");
                        clearInterval(pollInterval);
                        pollInterval = null;
                    }
                }
            } catch (err) {
                console.error(err);
            }
        }

        function generateSkeleton(count) {
            let html = '';
            for(let i=0; i<count; i++) {
                html += `
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 shadow-sm border-0">
                            <div class="card-body">
                                <div class="skeleton mb-2" style="width: 60%; height: 24px;"></div>
                                <div class="skeleton mb-4" style="width: 80%; height: 16px;"></div>
                                <div class="skeleton mt-auto" style="width: 100%; height: 38px;"></div>
                            </div>
                        </div>
                    </div>`;
            }
            return html;
        }

        // --- 3. åˆ›å»ºè¯¾ç¨‹ ---
        async function createCourse() {
            const name = document.getElementById('c-name').value.trim();
            const sem = document.getElementById('c-sem').value.trim();
            const loc = document.getElementById('c-loc').value.trim();

            if(!name) { alert("è¯·è¾“å…¥è¯¾ç¨‹å"); return; }

            try {
                // ä½¿ç”¨ authFetch
                const res = await authFetch('/courses/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({course_name: name, semester: sem, location: loc})
                });
                
                if (!res) return; // 401å·²å¤„ç†
                const data = await res.json();

                if (!res.ok) throw new Error(data.detail);

                document.getElementById('c-name').value = "";
                document.getElementById('c-sem').value = "";
                document.getElementById('c-loc').value = "";
                
                showToast(`âœ… è¯¾ç¨‹ "${name}" åˆ›å»ºæˆåŠŸ`);
                loadCourses(); 

            } catch (err) {
                alert("åˆ›å»ºå¤±è´¥: " + err.message);
            }
        }

        // --- 4. åˆ é™¤è¯¾ç¨‹ ---
        async function deleteCourse(id) {
            if(!confirm("ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ")) return;
            try {
                // ä½¿ç”¨ authFetch
                const res = await authFetch(`/courses/${id}`, { method: 'DELETE' });
                if (!res) return;

                if(res.ok) {
                    showToast("ğŸ—‘ï¸ è¯¾ç¨‹å·²åˆ é™¤");
                    loadCourses();
                } else alert("åˆ é™¤å¤±è´¥");
            } catch(e) { alert("ç½‘ç»œé”™è¯¯"); }
        }

        // --- 5. é‡æ–°ç”Ÿæˆ ---
        async function regenerate(id) {
            try {
                showToast("â³ æ­£åœ¨è¯·æ±‚é‡å¯...");
                // ä½¿ç”¨ authFetch
                const res = await authFetch(`/courses/${id}/regenerate`, { method: 'POST' });
                if (!res) return;

                if (res.ok) {
                    showToast("âœ… ä»»åŠ¡å·²é‡å¯");
                    // å»¶è¿Ÿåˆ·æ–°ï¼Œç¡®ä¿åç«¯çŠ¶æ€å·²æ›´æ–°
                    setTimeout(loadCourses, 500);
                } else {
                    const data = await res.json();
                    alert("é‡å¯å¤±è´¥: " + data.detail);
                    loadCourses();
                }
            } catch (e) { alert("ç½‘ç»œé”™è¯¯"); }
        }
    </script>
</body>
</html>